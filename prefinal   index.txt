const { Client, LocalAuth } = require('whatsapp-web.js');
const express = require('express');
const qrcode = require('qrcode-terminal');
const fs = require('fs');
const { WebhookClient } = require('dialogflow-fulfillment');
const { initializeApp, cert } = require('firebase-admin/app');
const { getFirestore } = require('firebase-admin/firestore');
const dialogflow = require('@google-cloud/dialogflow');
const uuid = require('uuid');

// ðŸ” Cargar credenciales desde variable de entorno o archivo
let firebaseCredentials;
try {
  if (process.env.FIREBASE_JSON) {
    firebaseCredentials = JSON.parse(
      Buffer.from(process.env.FIREBASE_JSON, 'base64').toString('utf8')
    );
  } else if (fs.existsSync('./credentials/firebase.json')) {
    firebaseCredentials = require('./credentials/firebase.json');
  } else {
    console.error('âŒ FIREBASE_JSON no estÃ¡ definido y no se encontrÃ³ credentials/firebase.json');
    process.exit(1);
  }
} catch (err) {
  console.error('âŒ No se pudo cargar FIREBASE_JSON:', err.message);
  process.exit(1);
}

// ðŸ”¥ Inicializar Firebase
initializeApp({
  credential: cert(firebaseCredentials),
});
const db = getFirestore();

// ðŸ¤– Inicializar cliente de WhatsApp
const client = new Client({
  authStrategy: new LocalAuth(),
  puppeteer: {
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  }
});

// ðŸŒ Inicializar servidor Express
const app = express();
const port = process.env.PORT || 8080;
app.use(express.json());

app.get('/', (req, res) => {
  res.send('ðŸŸ¢ Bot de WhatsApp corriendo');
});

// ðŸ§  Webhook para Dialogflow
app.post('/webhook', express.json(), (req, res) => {
  if (!req.body || Object.keys(req.body).length === 0) {
    return res.status(400).json({ error: 'El cuerpo de la solicitud estÃ¡ vacÃ­o' });
  }

  const agentRequest = req.body;

  if (!agentRequest.queryResult || !agentRequest.queryResult.intent) {
    console.error('âŒ La solicitud no contiene un intent vÃ¡lido:', JSON.stringify(agentRequest, null, 2));
    return res.status(400).json({ error: 'Solicitud invÃ¡lida: falta queryResult.intent' });
  }

  const agent = new WebhookClient({ request: req, response: res });

  function welcome(agent) {
    agent.add(`Hola ðŸ‘‹, soy tu asistente virtual.`);
  }

  function fallback(agent) {
    agent.add(`No entendÃ­ eso. Â¿PodÃ©s repetirlo?`);
  }

  const intentMap = new Map();
  intentMap.set('Default Welcome Intent', welcome);
  intentMap.set('Default Fallback Intent', fallback);

  agent.handleRequest(intentMap);
});

// ðŸŸ¡ Inicializar WhatsApp
client.on('qr', (qr) => {
  qrcode.generate(qr, { small: true });
});

client.on('ready', () => {
  console.log('âœ… Cliente de WhatsApp listo');
});

client.on('message', async (message) => {
  console.log(`ðŸ“© Mensaje recibido: ${message.body}`);
  const userId = message.from;

  // ðŸš« Ignorar mensajes de grupo por defecto
  const isGroup = userId.endsWith('@g.us');
  if (isGroup) {
    const contextoRef = db.collection('contextos').doc(userId);
    const contextoSnap = await contextoRef.get();
    const contexto = contextoSnap.exists ? contextoSnap.data() : {};

    // Activar el bot solo si alguien dice "bot"
    if (message.body.toLowerCase() === 'bot') {
      await contextoRef.set({ modo: 'bot' });
      return message.reply('ðŸ¤– Bot activado. Â¿En quÃ© puedo ayudarte?');
    }

    // Si no estÃ¡ activado, ignorar mensaje
    if (contexto.modo !== 'bot') {
      return;
    }
  }

  // ðŸ” Comandos generales
  if (message.body.toLowerCase() === 'operador') {
    await db.collection('contextos').doc(userId).set({ modo: 'humano' });
    return message.reply('ðŸ™‹â€â™‚ï¸ Te derivamos con un operador humano. EscribÃ­ "bot" para volver conmigo.');
  }

  const contextoRef = db.collection('contextos').doc(userId);
  const contextoSnap = await contextoRef.get();
  const contexto = contextoSnap.exists ? contextoSnap.data() : {};
  if (contexto.modo === 'humano') {
    return;
  }

  // ðŸ§  Enviar a Dialogflow
  const sessionClient = new dialogflow.SessionsClient({
    credentials: {
      client_email: firebaseCredentials.client_email,
      private_key: firebaseCredentials.private_key,
    },
    projectId: firebaseCredentials.project_id,
  });

  const sessionPath = sessionClient.projectAgentSessionPath(
    firebaseCredentials.project_id,
    userId
  );

  const request = {
    session: sessionPath,
    queryInput: {
      text: {
        text: message.body,
        languageCode: 'es',
      },
    },
  };

  try {
    const responses = await sessionClient.detectIntent(request);
    const result = responses[0].queryResult;
    const reply = result.fulfillmentText || 'ðŸ¤– Lo siento, no tengo una respuesta para eso.';
    await message.reply(reply);
    console.log(`ðŸ¤– Respuesta enviada: ${reply}`);
  } catch (error) {
    console.error('âŒ Error al enviar mensaje a Dialogflow:', error);
    await message.reply('âš ï¸ OcurriÃ³ un error. IntentÃ¡ mÃ¡s tarde.');
  }
});

client.initialize();

// ðŸš€ Servidor Express
app.listen(port, () => {
  console.log(`ðŸš€ Servidor Express activo en puerto ${port}`);
});

